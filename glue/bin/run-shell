#!/bin/bash
set -e

if [ $(id -u) != 0 ] && [ ! -v DISPLAY ] && ! snapctl is-connected login-session-control; then
  echo "ERROR: You need one of: root, a DISPLAY, or to connect the login-session-control interface."
  echo ""
  echo "To connect the login-session-control and desktop-launch interfaces and add to the login menu:"
  echo "  /snap/confined-shell/current/bin/setup.sh"
  exit 1
fi

if ! snapctl is-connected desktop-launch; then
  echo "ERROR: You need to connect the desktop-launch interface."
  echo ""
  echo "To connect the login-session-control and desktop-launch interfaces and add to the login menu:"
  echo "  /snap/confined-shell/current/bin/setup.sh"
  exit 1
fi

export XDG_RUNTIME_DIR=$(dirname $XDG_RUNTIME_DIR)
mkdir -p $XDG_RUNTIME_DIR -m 700
mkdir -p $XDG_CACHE_HOME

miriway_config="$SNAP_USER_DATA/.config/miriway-shell.config"
yambar_config="$SNAP_USER_DATA/.config/yambar/config.yml"

[ ! -d "$SNAP_USER_DATA/.config" ] && mkdir $SNAP_USER_DATA/.config -m 700

# Ensure we have a config file with the fixed options
if [ ! -e "${miriway_config}" ]; then
cat <<EOT > "${miriway_config}"
shell-component=dbus-update-activation-environment --systemd --verbose WAYLAND_DISPLAY XDG_DATA_DIRS=/usr/local/share:/usr/share:/var/lib/snapd/desktop MOZ_ENABLE_WAYLAND

shell-ctrl-alt=a:wofi --show drun --location top_left
shell-meta=a:wofi --show drun --location top_left
shell-component=wayland-launch swaybg -i /snap/${SNAP_INSTANCE_NAME}/current/usr/share/backgrounds/warty-final-ubuntu.png
shell-component=wayland-launch yambar
EOT
fi

# Ensure we have a config file with the fixed options
if [ ! -e "${yambar_config}" ]; then
  mkdir -p $(dirname "${yambar_config}")
cat <<EOT > "${yambar_config}"
awesome: &awesome Font Awesome 6 Free:style=solid:pixelsize=14
ubuntu: &ubuntu Font Ubuntu 6 Free:style=solid:pixelsize=14

bar:
  location: top
  height: 21
  background: 282828ff
  font: *ubuntu

  center:
    - clock:
        content:
          - string:
              margin: 5
              text: "{date} {time}"
              deco: &greybg
                background:
                  color: 3f3f3fff

  right:
    - network:
        name: wlp4s0
        content:
          map:
            deco: *greybg
            margin: 5
            default: {string: {text: , font: *awesome}}
            conditions:
              state == down: {string: {text: , font: *awesome}}
              state == up:
                map:
                  default:
                    - string: {text: , font: *awesome, deco: *greybg}
#                    - string: {text: "{ssid} {dl-speed:mb}/{ul-speed:mb} Mb/s" }

                  conditions:
                    ipv4 == "":
                      - string: {text: , font: *awesome}
#                      - string: {text: "{ssid} {dl-speed:mb}/{ul-speed:mb} Mb/s"}
    - battery:
        name: BAT0
        anchors:
          discharging: &discharging
            list:
              items:
                - ramp:
                    tag: capacity
                    items:
                      - string: {text: , foreground: ff0000ff, font: *awesome}
                      - string: {text: , foreground: ffa600ff, font: *awesome}
                      - string: {text: , font: *awesome}
                      - string: {text: , font: *awesome}
                      - string: {text: , font: *awesome}
                      - string: {text: , font: *awesome}
                      - string: {text: , font: *awesome}
                      - string: {text: , font: *awesome}
                      - string: {text: , font: *awesome}
                      - string: {text: , foreground: 00ff00ff, font: *awesome}
                - string: {text: "{capacity}% {estimate}"}
        content:
          map:
            deco: *greybg
            margin: 5
            conditions:
              state == unknown:
                <<: *discharging
              state == discharging:
                <<: *discharging
              state == charging:
                - string: {text: , foreground: 00ff00ff, font: *awesome}
                - string: {text: "{capacity}% {estimate}"}
              state == full:
                - string: {text: , foreground: 00ff00ff, font: *awesome}
                - string: {text: "{capacity}% full"}
              state == "not charging":
                - ramp:
                    tag: capacity
                    items:
                      - string: {text:  , foreground: ff0000ff, font: *awesome}
                      - string: {text:  , foreground: ffa600ff, font: *awesome}
                      - string: {text:  , foreground: 00ff00ff, font: *awesome}
                      - string: {text:  , foreground: 00ff00ff, font: *awesome}
                      - string: {text:  , foreground: 00ff00ff, font: *awesome}
                      - string: {text:  , foreground: 00ff00ff, font: *awesome}
                      - string: {text:  , foreground: 00ff00ff, font: *awesome}
                      - string: {text:  , foreground: 00ff00ff, font: *awesome}
                      - string: {text:  , foreground: 00ff00ff, font: *awesome}
                      - string: {text:  , foreground: 00ff00ff, font: *awesome}
                - string: {text: "{capacity}%"}

  left:
    - label:
        content:
          string:
            text: " start"
            deco: *greybg
            margin: 5
            on-click: wofi --show drun --location top_left

    - foreign-toplevel:
        content:
          map:
            deco: *greybg
            conditions:
              ~activated: {empty: {}}
              activated:
                - string: {text: "{app-id}: {title}"}
EOT
fi

cd $HOME
unset WAYLAND_DISPLAY
exec $@

